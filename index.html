<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Koo Cash Loan Tracker</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --muted: #94a3b8;
      --text: #e5e7eb;
      --brand: #22c55e;
      --brand-2: #06b6d4;
      --warn: #f59e0b;
      --danger: #ef4444;
      --ok: #10b981;
      --card: #0b1220;
      --border: #1f2937;
      --radius: 12px;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
    }
    
    /* Light theme variables */
    [data-theme="light"] {
      --bg: #f1f5f9;
      --panel: #ffffff;
      --muted: #64748b;
      --text: #1e293b;
      --card: #ffffff;
      --border: #e2e8f0;
      --shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    
    * { 
      box-sizing: border-box; 
      margin: 0; 
      padding: 0; 
      transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }
    
    html, body { 
      height: 100%; 
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background-color: var(--bg);
      color: var(--text);
    }
    
    body {
      background: radial-gradient(1200px 800px at 80% -10%, rgba(34,197,94,.12), transparent 40%),
                  radial-gradient(1000px 600px at -10% 10%, rgba(6,182,212,.12), transparent 40%),
                  var(--bg);
      line-height: 1.5;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    
    .app-wrapper {
      width: 100%;
      max-width: 1200px;
      height: 100%;
      max-height: 95vh;
      display: flex;
      flex-direction: column;
    }
    
    .container { 
      width: 100%;
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    .row { 
      display: grid; 
      grid-template-columns: 1fr; 
      gap: 16px;
      flex: 1;
      overflow: hidden;
    }
    
    @media (min-width: 1024px){ 
      .row { 
        grid-template-columns: 360px 1fr; 
      } 
    }
    
    .card { 
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.0)); 
      border: 1px solid var(--border); 
      border-radius: var(--radius); 
      box-shadow: var(--shadow); 
      display: flex;
      flex-direction: column;
    }
    
    [data-theme="light"] .card {
      background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.0));
    }
    
    .card h2 { 
      margin: 0; 
      font-size: 18px; 
      font-weight: 700; 
      letter-spacing: .2px; 
    }
    
    .card .header { 
      padding: 16px 16px 0 16px; 
      display: flex; 
      align-items: center; 
      justify-content: space-between; 
    }
    
    .card .content { 
      padding: 16px; 
      overflow: auto;
      flex: 1;
    }
    
    input, select, textarea { 
      width: 100%; 
      padding: 12px; 
      border-radius: var(--radius); 
      border: 1px solid var(--border); 
      background: var(--card); 
      color: var(--text); 
      outline: none; 
      font-family: inherit;
      font-size: 14px;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
    }
    
    textarea { 
      min-height: 72px; 
      resize: vertical; 
    }
    
    label { 
      font-size: 12px; 
      color: var(--muted); 
      margin-bottom: 6px; 
      display: inline-block; 
      font-weight: 500;
    }
    
    .grid { 
      display: grid; 
      gap: 12px; 
    }
    
    .grid-2 { 
      grid-template-columns: 1fr 1fr; 
    }
    
    .grid-3 { 
      grid-template-columns: repeat(3, 1fr); 
    }
    
    .grid-4 { 
      grid-template-columns: repeat(4, 1fr); 
    }
    
    .btn { 
      border: 1px solid var(--border); 
      background: #0c1424; 
      color: var(--text); 
      padding: 10px 14px; 
      border-radius: var(--radius); 
      cursor: pointer; 
      font-weight: 600; 
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: all 0.2s ease;
    }
    
    [data-theme="light"] .btn {
      background: #f1f5f9;
    }
    
    .btn:hover { 
      filter: brightness(1.1); 
      transform: translateY(-1px);
    }
    
    .btn.primary { 
      background: linear-gradient(180deg, var(--brand), #16a34a); 
      color: #04110a; 
      border: none; 
    }
    
    .btn.secondary { 
      background: linear-gradient(180deg, var(--brand-2), #0891b2); 
      color: #031018; 
      border: none; 
    }
    
    .btn.warn { 
      background: linear-gradient(180deg, var(--warn), #d97706); 
      color: #1b1203; 
      border: none; 
    }
    
    .btn.danger { 
      background: linear-gradient(180deg, var(--danger), #dc2626); 
      color: #1b0505; 
      border: none; 
    }
    
    .btn.ghost { 
      background: transparent; 
      border: 1px dashed var(--border); 
    }
    
    .toolbar { 
      display:flex; 
      gap: 8px; 
      flex-wrap: wrap; 
    }
    
    table { 
      width: 100%; 
      border-collapse: collapse; 
    }
    
    th, td { 
      border-bottom: 1px solid var(--border); 
      padding: 12px 8px; 
      text-align: left; 
      font-size: 14px; 
    }
    
    th { 
      color: var(--muted); 
      font-weight: 600; 
      font-size: 13px;
    }
    
    tr:hover td { 
      background: rgba(255,255,255,0.02); 
    }
    
    [data-theme="light"] tr:hover td {
      background: rgba(0,0,0,0.02);
    }
    
    .badge { 
      display:inline-flex; 
      align-items:center; 
      gap:6px; 
      padding:4px 10px; 
      border-radius:999px; 
      font-size:12px; 
      font-weight:700; 
      letter-spacing:.2px; 
      border:1px solid var(--border); 
    }
    
    .badge.ok { 
      background: rgba(16,185,129,.1); 
      color: #34d399; 
    }
    
    .badge.danger { 
      background: rgba(239,68,68,.1); 
      color: #f87171; 
    }
    
    .badge.warn { 
      background: rgba(245,158,11,.1); 
      color: #fbbf24; 
    }
    
    .badge.neutral { 
      background: rgba(148,163,184,.08); 
      color: #cbd5e1; 
    }
    
    .muted { 
      color: var(--muted); 
    }
    
    .mono { 
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; 
    }
    
    .flex { 
      display:flex; 
      gap: 10px; 
      align-items: center; 
    }
    
    .right { 
      margin-left: auto; 
    }
    
    .empty { 
      text-align:center; 
      padding: 36px; 
      color: var(--muted); 
      border:1px dashed var(--border); 
      border-radius: var(--radius); 
    }
    
    .footer { 
      display:flex; 
      gap: 10px; 
      align-items:center; 
      justify-content: space-between; 
      flex-wrap: wrap; 
      margin-top: 12px; 
    }
    
    .pill { 
      border-radius: 999px; 
      padding: 8px 12px; 
      border: 1px solid var(--border); 
      background: rgba(255,255,255,.03); 
      font-size: 13px;
    }
    
    [data-theme="light"] .pill {
      background: rgba(0,0,0,.03);
    }
    
    dialog { 
      border: 1px solid var(--border); 
      background: var(--panel); 
      color: var(--text); 
      border-radius: 14px; 
      width: min(560px, 96vw); 
      padding: 0;
    }
    
    dialog::backdrop { 
      background: rgba(0,0,0,.6); 
    }
    
    .kbd { 
      font-size: 12px; 
      border: 1px solid var(--border); 
      padding: 2px 6px; 
      border-radius: 6px; 
      background: #0b1220; 
    }
    
    [data-theme="light"] .kbd {
      background: #f1f5f9;
    }
    
    .form-group {
      margin-bottom: 12px;
    }
    
    .notification-badge {
      position: relative;
    }
    
    .notification-badge::after {
      content: '';
      position: absolute;
      top: -4px;
      right: -4px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--danger);
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }
    
    .status-active { background: var(--brand); }
    .status-overdue { background: var(--danger); }
    .status-collected { background: var(--ok); }
    
    /* Animation for new items */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease;
    }
    
    /* Loading spinner */
    .spinner {
      width: 24px;
      height: 24px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: var(--brand);
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Connection status */
    .connection-online {
      color: var(--brand);
    }
    
    .connection-offline {
      color: var(--danger);
    }
    
    .connection-connecting {
      color: var(--warn);
    }
    
    /* Auth Screen */
    .auth-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      max-width: 400px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    
    .auth-logo {
      font-size: 48px;
      margin-bottom: 20px;
      color: var(--brand);
    }
    
    .auth-title {
      font-size: 28px;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .auth-subtitle {
      color: var(--muted);
      margin-bottom: 30px;
      font-size: 16px;
    }
    
    .auth-form {
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    
    .auth-error {
      color: var(--danger);
      margin-top: 15px;
      font-size: 14px;
      min-height: 20px;
    }
    
    .auth-switch {
      margin-top: 30px;
      color: var(--muted);
      font-size: 14px;
      border-top: 1px solid var(--border);
      padding-top: 15px;
      width: 100%;
    }
    
    .auth-switch a {
      color: var(--brand);
      text-decoration: none;
      cursor: pointer;
      font-weight: 600;
    }
    
    .auth-switch a:hover {
      text-decoration: underline;
    }
    
    /* Table container with fixed header and scrollable body */
    .table-container {
      overflow: auto;
      max-height: 100%;
      position: relative;
    }
    
    .table-container table {
      width: 100%;
    }
    
    .table-container thead {
      position: sticky;
      top: 0;
      background: var(--card);
      z-index: 10;
    }
    
    /* Print styles for receipt */
    @media print {
      body * {
        visibility: hidden;
      }
      #receipt-printable, #receipt-printable * {
        visibility: visible;
      }
      #receipt-printable {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
    
    /* Toast notifications */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .toast {
      padding: 12px 16px;
      border-radius: var(--radius);
      background: var(--panel);
      border: 1px solid var(--border);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
    }
    
    .toast.success {
      border-left: 4px solid var(--brand);
    }
    
    .toast.error {
      border-left: 4px solid var(--danger);
    }
    
    .toast.warning {
      border-left: 4px solid var(--warn);
    }
    
    @keyframes toastIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes toastOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }
    
    /* Dashboard summary cards */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .summary-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      display: flex;
      flex-direction: column;
    }
    
    [data-theme="light"] .summary-card {
      background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.005));
    }
    
    .summary-card h3 {
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 8px 0;
      font-weight: 600;
    }
    
    .summary-card .value {
      font-size: 24px;
      font-weight: 700;
      margin: 0;
    }
    
    .summary-card .trend {
      font-size: 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .trend.up {
      color: var(--brand);
    }
    
    .trend.down {
      color: var(--danger);
    }
    
    /* Theme toggle button */
    .theme-toggle {
      background: none;
      border: none;
      color: var(--text);
      cursor: pointer;
      font-size: 18px;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .theme-toggle:hover {
      background: rgba(255,255,255,0.1);
    }
    
    [data-theme="light"] .theme-toggle:hover {
      background: rgba(0,0,0,0.05);
    }
    
    /* Reminder dialog */
    .reminder-list {
      max-height: 300px;
      overflow-y: auto;
      margin: 16px 0;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
    }
    
    .reminder-item {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .reminder-item:last-child {
      border-bottom: none;
    }
    
    .reminder-client {
      font-weight: 600;
    }
    
    .reminder-details {
      font-size: 13px;
      color: var(--muted);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }
      
      .app-wrapper {
        max-height: 98vh;
      }
      
      .container {
        padding: 16px;
      }
      
      .grid-2, .grid-3, .grid-4 {
        grid-template-columns: 1fr;
      }
      
      .toolbar {
        justify-content: center;
      }
      
      .card .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 12px;
      }
      
      .footer {
        flex-direction: column;
        align-items: stretch;
      }
      
      .toast-container {
        left: 10px;
        right: 10px;
        top: 10px;
      }
      
      .summary-cards {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <!-- Auth Screen -->
  <div id="auth-screen" class="card auth-container">
    <div class="auth-logo">üí∞</div>
    <h1 class="auth-title">Koo Cash Loan Tracker</h1>
    <p class="auth-subtitle">Sign in or create an account to continue</p>
    
    <!-- Login Form -->
    <form id="login-form" class="auth-form">
      <div class="form-group">
        <label for="login-email">Email</label>
        <input type="email" id="login-email" required placeholder="Enter your email" />
      </div>
      
      <div class="form-group">
        <label for="login-password">Password</label>
        <input type="password" id="login-password" required placeholder="Enter your password" />
      </div>
      
      <button type="submit" class="btn primary">Sign In</button>
      
      <div id="login-error" class="auth-error"></div>
    </form>
    
    <!-- Signup Form (Initially Hidden) -->
    <form id="signup-form" class="auth-form" style="display: none;">
      <div class="form-group">
        <label for="signup-name">Full Name</label>
        <input type="text" id="signup-name" required placeholder="Enter your full name" />
      </div>
      
      <div class="form-group">
        <label for="signup-email">Email</label>
        <input type="email" id="signup-email" required placeholder="Enter your email" />
      </div>
      
      <div class="form-group">
        <label for="signup-password">Password (min. 6 characters)</label>
        <input type="password" id="signup-password" required minlength="6" placeholder="Create a password" />
      </div>
      
      <div class="form-group">
        <label for="signup-confirm">Confirm Password</label>
        <input type="password" id="signup-confirm" required placeholder="Confirm your password" />
      </div>
      
      <button type="submit" class="btn primary">Create Account</button>
      
      <div id="signup-error" class="auth-error"></div>
    </form>
    
    <div class="auth-switch">
      <span id="auth-switch-text">Don't have an account?</span>
      <a id="auth-switch-link">Sign up</a>
    </div>
  </div>

  <!-- Main Application (Initially Hidden) -->
  <div id="app-container" class="app-wrapper" style="display: none;">
    <header class="card" style="padding:16px; margin-bottom: 16px; flex-shrink: 0;">
      <div class="flex" style="align-items:flex-start; justify-content: space-between; gap: 16px; flex-wrap: wrap;">
        <div>
          <h1 style="margin:0; font-size: 28px;">Koo Cash Loan Tracker</h1>
          <p class="muted" style="margin:6px 0 0 0;">Professional loan management with real-time cloud sync</p>
        </div>
        <div class="toolbar">
          <button class="theme-toggle" id="theme-toggle" title="Toggle theme">
            <i class="fas fa-moon"></i>
          </button>
          <div id="connection-status" class="pill connection-connecting" style="display: flex; align-items: center; gap: 6px;">
            <div class="spinner"></div>
            <span>Connecting to Firebase...</span>
          </div>
          <div class="pill" style="display: flex; align-items: center; gap: 6px;">
            <span>üë§</span>
            <span id="user-name">User</span>
          </div>
          <button class="btn" id="btn-reminders" title="View reminders">
            <i class="fas fa-bell"></i>
            <span id="reminder-count">0</span>
          </button>
          <button class="btn" id="btn-logout" title="Sign out"><span>üö™ Sign Out</span></button>
          <button class="btn ghost" id="btn-export-json" title="Export JSON"><span>Export JSON</span></button>
          <button class="btn secondary" id="btn-export-csv" title="Export CSV"><span>Export CSV</span></button>
          <button class="btn danger" id="btn-clear" title="Danger: Clear all data"><span>Clear All</span></button>
        </div>
      </div>
    </header>

    <!-- Dashboard Summary Cards -->
    <div class="summary-cards" id="dashboard-summary">
      <div class="summary-card">
        <h3>Total Loans</h3>
        <p class="value mono" id="total-loans">0</p>
        <div class="trend up" id="loans-trend">
          <i class="fas fa-arrow-up"></i>
          <span>0% from last month</span>
        </div>
      </div>
      <div class="summary-card">
        <h3>Active Loans</h3>
        <p class="value mono" id="active-loans">0</p>
        <div class="trend up" id="active-trend">
          <i class="fas fa-arrow-up"></i>
          <span>0% from last month</span>
        </div>
      </div>
      <div class="summary-card">
        <h3>Amount Due</h3>
        <p class="value mono" id="total-due">$0.00</p>
        <div class="trend up" id="due-trend">
          <i class="fas fa-arrow-up"></i>
          <span>0% from last month</span>
        </div>
      </div>
      <div class="summary-card">
        <h3>Overdue Loans</h3>
        <p class="value mono" id="overdue-loans">0</p>
        <div class="trend up" id="overdue-trend">
          <i class="fas fa-arrow-up"></i>
          <span>0% from last month</span>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="row">
        <section class="card">
          <div class="header">
            <h2>New Loan</h2>
            <span class="muted mono" id="now"></span>
          </div>
          <div class="content">
            <form id="loanForm" class="grid">
              <div class="grid grid-2">
                <div class="form-group">
                  <label for="clientName">Client Name</label>
                  <input required id="clientName" placeholder="e.g. John Doe" />
                </div>
                <div class="form-group">
                  <label for="phone">Phone (optional)</label>
                  <input id="phone" placeholder="e.g. 0771234567" />
                </div>
              </div>

              <div class="grid grid-3">
                <div class="form-group">
                  <label for="principal">Principal Amount</label>
                  <input required id="principal" type="number" min="0" step="0.01" placeholder="e.g. 1500" />
                </div>
                <div class="form-group">
                  <label for="interestPct">Interest %</label>
                  <input required id="interestPct" type="number" min="0" step="0.01" placeholder="e.g. 50" />
                </div>
                <div class="form-group">
                  <label for="interestType">Interest Type</label>
                  <select id="interestType">
                    <option value="flat">Flat</option>
                    <option value="compound_monthly">Compound (Monthly)</option>
                    <option value="compound_daily">Compound (Daily)</option>
                  </select>
                </div>
              </div>

              <div class="grid grid-2">
                <div class="form-group">
                  <label for="issueDate">Issue Date</label>
                  <input required id="issueDate" type="date" />
                </div>
                <div class="form-group">
                  <label for="dueDate">Due Date</label>
                  <input required id="dueDate" type="date" />
                </div>
              </div>

              <div class="grid grid-2">
                <div class="form-group">
                  <label for="currency">Currency</label>
                  <select id="currency">
                    <option value="USD">USD</option>
                    <option value="ZWL">ZWL</option>
                    <option value="ZAR">ZAR</option>
                    <option value="EUR">EUR</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="reference">Reference / ID (optional)</label>
                  <input id="reference" placeholder="e.g. NatID / File #" />
                </div>
              </div>

              <div class="form-group">
                <label for="notes">Notes (optional)</label>
                <textarea id="notes" placeholder="Add terms, address, collateral, etc."></textarea>
              </div>

              <div class="footer">
                <div class="muted">Total Due: <span class="mono" id="totalPreview">0.00</span></div>
                <div class="toolbar">
                  <button class="btn ghost" type="button" id="btn-receipt-preview">Preview</button>
                  <button class="btn primary" type="submit" id="btn-submit-loan">
                    <span>Add Loan</span>
                  </button>
                </div>
              </div>
            </form>
          </div>
        </section>

        <section class="card">
          <div class="header">
            <h2>Loans</h2>
            <div class="toolbar">
              <input id="search" placeholder="Search name/phone/ref‚Ä¶ (Ctrl+/)" />
              <select id="statusFilter" title="Filter by status">
                <option value="all">All</option>
                <option value="active">Active</option>
                <option value="overdue">Overdue</option>
                <option value="collected">Collected</option>
              </select>
              <select id="sortBy" title="Sort by">
                <option value="dueDate">Due Date</option>
                <option value="createdAt">Created</option>
                <option value="clientName">Client</option>
                <option value="balance">Balance</option>
              </select>
            </div>
          </div>
          <div class="content">
            <div class="table-container" id="tableWrap">
              <div class="empty">Connecting to database... Please wait.</div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- Payment Modal -->
  <dialog id="paymentDialog">
    <form method="dialog" id="paymentForm" style="padding:16px;" class="grid">
      <h3 style="margin:0 0 8px 0;">Record Payment</h3>
      <div class="muted" id="paymentLoanTitle"></div>
      <div class="grid grid-3" style="margin-top:8px;">
        <div class="form-group">
          <label for="payAmount">Amount</label>
          <input id="payAmount" type="number" min="0" step="0.01" required />
        </div>
        <div class="form-group">
          <label for="payDate">Date</label>
          <input id="payDate" type="date" required />
        </div>
        <div class="form-group">
          <label for="payNote">Note</label>
          <input id="payNote" placeholder="optional" />
        </div>
      </div>
      <div class="footer">
        <div class="muted">Tip: Use <span class="kbd">Enter</span> to save</div>
        <div class="toolbar">
          <button class="btn ghost" value="cancel" type="button">Cancel</button>
          <button class="btn primary" value="submit" id="btn-submit-payment">
            <span>Save Payment</span>
          </button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Edit Modal -->
  <dialog id="editDialog">
    <form method="dialog" id="editForm" style="padding:16px;" class="grid">
      <h3 style="margin:0 0 8px 0;">Edit Loan</h3>
      <div class="grid grid-2">
        <div class="form-group">
          <label for="editClientName">Client Name</label>
          <input id="editClientName" />
        </div>
        <div class="form-group">
          <label for="editPhone">Phone</label>
          <input id="editPhone" />
        </div>
      </div>
      <div class="grid grid-3">
        <div class="form-group">
          <label for="editPrincipal">Principal</label>
          <input id="editPrincipal" type="number" min="0" step="0.01" />
        </div>
        <div class="form-group">
          <label for="editInterestPct">Interest %</label>
          <input id="editInterestPct" type="number" min="0" step="0.01" />
        </div>
        <div class="form-group">
          <label for="editInterestType">Interest Type</label>
          <select id="editInterestType">
            <option value="flat">Flat</option>
            <option value="compound_monthly">Compound (Monthly)</option>
            <option value="compound_daily">Compound (Daily)</option>
          </select>
        </div>
      </div>
      <div class="grid grid-2">
        <div class="form-group">
          <label for="editIssueDate">Issue Date</label>
          <input id="editIssueDate" type="date" />
        </div>
        <div class="form-group">
          <label for="editDueDate">Due Date</label>
          <input id="editDueDate" type="date" />
        </div>
      </div>
      <div class="grid grid-2">
        <div class="form-group">
          <label for="editCurrency">Currency</label>
          <select id="editCurrency">
            <option value="USD">USD</option>
            <option value="ZWL">ZWL</option>
            <option value="ZAR">ZAR</option>
            <option value="EUR">EUR</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editReference">Reference</label>
          <input id="editReference" />
        </div>
      </div>
      <div class="form-group">
        <label for="editNotes">Notes</label>
        <textarea id="editNotes"></textarea>
      </div>
      <div class="footer">
        <div></div>
        <div class="toolbar">
          <button class="btn ghost" value="cancel" type="button">Cancel</button>
          <button class="btn primary" value="submit" id="btn-submit-edit">
            <span>Save Changes</span>
          </button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Receipt Modal -->
  <dialog id="receiptDialog">
    <div style="padding:16px;">
      <div id="receiptContent"></div>
      <div id="receipt-printable" style="display:none;"></div>
      <div class="footer">
        <div class="muted">Print or copy for client</div>
        <div class="toolbar">
          <button class="btn ghost" id="btn-close-receipt">Close</button>
          <button class="btn" id="btn-copy-receipt">Copy Text</button>
          <button class="btn secondary" id="btn-print-receipt">Print</button>
          <button class="btn" id="btn-export-pdf">Export PDF</button>
          <button class="btn" id="btn-share-whatsapp">Share via WhatsApp</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- Reminder Modal -->
  <dialog id="reminderDialog">
    <div style="padding:16px;">
      <h3 style="margin:0 0 16px 0;">Loan Reminders</h3>
      <div class="reminder-list" id="reminder-list">
        <div class="empty">No reminders at this time</div>
      </div>
      <div class="footer">
        <div class="muted" id="reminder-summary">0 upcoming reminders</div>
        <div class="toolbar">
          <button class="btn ghost" id="btn-close-reminders">Close</button>
          <button class="btn primary" id="btn-send-reminders">Send All Reminders</button>
        </div>
      </div>
    </div>
  </dialog>

  <!-- WhatsApp Modal -->
  <dialog id="whatsappDialog">
    <form method="dialog" id="whatsappForm" style="padding:16px;" class="grid">
      <h3 style="margin:0 0 8px 0;">Send WhatsApp Reminder</h3>
      <div class="muted" id="whatsappLoanTitle"></div>
      <div class="form-group">
        <label for="whatsappNumber">Phone Number</label>
        <input id="whatsappNumber" type="tel" required placeholder="e.g. 0771234567" />
      </div>
      <div class="form-group">
        <label for="whatsappMessage">Message</label>
        <textarea id="whatsappMessage" rows="4" required></textarea>
      </div>
      <div class="footer">
        <div class="muted">Message will be sent via WhatsApp</div>
        <div class="toolbar">
          <button class="btn ghost" value="cancel" type="button">Cancel</button>
          <button class="btn primary" value="submit" id="btn-send-whatsapp">
            <span>Open WhatsApp</span>
          </button>
        </div>
      </div>
    </form>
  </dialog>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  
  <!-- html2pdf library for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBiNWVZ98c_AwPaEoyxQac6TXjfkpfA3kw",
      authDomain: "koo-cash-loan.firebaseapp.com",
      projectId: "koo-cash-loan",
      storageBucket: "koo-cash-loan.firebasestorage.app",
      messagingSenderId: "141003963427",
      appId: "1:141003963427:web:dc1e6ef6c7a7c772350596",
      measurementId: "G-P63SDLN3PL"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
  </script>

  <script>
    // ====== UTILITY FUNCTIONS ======
    const utils = {
      // Toast notification system
      showToast: (message, type = 'success') => {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è';
        toast.innerHTML = `
          <span>${icon}</span>
          <span>${message}</span>
        `;
        
        toastContainer.appendChild(toast);
        
        // Remove toast after animation completes
        setTimeout(() => {
          toast.remove();
        }, 3000);
      },
      
      // Error handler
      handleError: (error, context = 'operation') => {
        console.error(`${context} error:`, error);
        
        let userMessage = 'An unexpected error occurred';
        
        if (error.code) {
          switch (error.code) {
            case 'permission-denied':
              userMessage = 'You do not have permission to perform this action';
              break;
            case 'unauthenticated':
              userMessage = 'Please sign in to continue';
              break;
            case 'not-found':
              userMessage = 'The requested resource was not found';
              break;
            case 'already-exists':
              userMessage = 'This item already exists';
              break;
            case 'failed-precondition':
              userMessage = 'Operation cannot be completed in current state';
              break;
            default:
              userMessage = error.message || `Error during ${context}`;
          }
        } else if (error.message) {
          userMessage = error.message;
        }
        
        utils.showToast(userMessage, 'error');
        return userMessage;
      },
      
      // Format currency
      formatCurrency: (amount, currencyCode = 'USD') => {
        const amountNum = Number(amount || 0);
        const symbols = { USD: '$', ZWL: 'Z$', ZAR: 'R', EUR: '‚Ç¨' };
        const symbol = symbols[currencyCode] || '';
        return `${symbol}${amountNum.toLocaleString(undefined, {
          minimumFractionDigits: 2,
          maximumFractionDigits: 2
        })}`;
      },
      
      // Format date
      formatDate: (dateString) => {
        if (!dateString) return '-';
        const date = new Date(dateString);
        // Handle invalid dates
        if (isNaN(date.getTime())) return '-';
        return date.toLocaleDateString();
      },
      
      // Get today's date in YYYY-MM-DD format
      todayISO: () => new Date().toISOString().slice(0, 10),
      
      // Generate a unique ID
      generateId: () => Math.random().toString(36).slice(2, 9) + Date.now().toString(36).slice(-4),
      
      // Debounce function for performance
      debounce: (func, wait) => {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      },
      
      // Validate form data
      validateForm: (formData) => {
        const errors = [];
        if (!formData.clientName?.trim()) errors.push('Client name is required');
        if (!formData.principal || formData.principal <= 0) errors.push('Valid principal amount is required');
        if (!formData.interestPct || formData.interestPct < 0) errors.push('Valid interest percentage is required');
        if (!formData.issueDate) errors.push('Issue date is required');
        if (!formData.dueDate) errors.push('Due date is required');
        
        // Validate dates
        if (formData.issueDate && formData.dueDate) {
          const issueDate = new Date(formData.issueDate);
          const dueDate = new Date(formData.dueDate);
          
          if (isNaN(issueDate.getTime())) errors.push('Invalid issue date');
          if (isNaN(dueDate.getTime())) errors.push('Invalid due date');
          if (dueDate < issueDate) errors.push('Due date must be after issue date');
        }
        
        return errors;
      },
      
      // Show loading state on a button
      showLoading: (button) => {
        if (!button) return () => {};
        const originalText = button.innerHTML;
        button.innerHTML = '<div class="spinner" style="width:16px;height:16px;"></div>';
        button.disabled = true;
        return () => {
          button.innerHTML = originalText;
          button.disabled = false;
        };
      },
      
      // Update connection status display
      updateConnectionStatus: (statusElement, status) => {
        if (!statusElement) return;
        
        statusElement.classList.remove('connection-connecting', 'connection-online', 'connection-offline');
        
        if (status === 'connecting') {
          statusElement.innerHTML = '<div class="spinner"></div><span>Connecting to Firebase...</span>';
          statusElement.classList.add('connection-connecting');
        } else if (status === 'online') {
          statusElement.innerHTML = '<span style="color:var(--brand);">‚óè</span> Online';
          statusElement.classList.add('connection-online');
        } else if (status === 'offline') {
          statusElement.innerHTML = '<span style="color:var(--danger);">‚óè</span> Offline - Data may not sync';
          statusElement.classList.add('connection-offline');
        }
      },
      
      // Safe number parsing
      safeParseFloat: (value, defaultValue = 0) => {
        if (value === null || value === undefined || value === '') return defaultValue;
        const parsed = parseFloat(value);
        return isNaN(parsed) ? defaultValue : parsed;
      },
      
      // Export to PDF using html2pdf
      exportToPdf: (element, filename) => {
        const options = {
          margin: 10,
          filename: filename,
          image: { type: 'jpeg', quality: 0.98 },
          html2canvas: { scale: 2 },
          jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };
        
        html2pdf().set(options).from(element).save();
      },
      
      // Calculate days between dates
      daysBetween: (date1, date2) => {
        const oneDay = 24 * 60 * 60 * 1000;
        const firstDate = new Date(date1);
        const secondDate = new Date(date2);
        return Math.round(Math.abs((firstDate - secondDate) / oneDay));
      },
      
      // Format phone number
      formatPhoneNumber: (phone) => {
        if (!phone) return '';
        // Remove all non-digit characters
        const cleaned = phone.replace(/\D/g, '');
        return cleaned;
      }
    };

    // ====== AUTHENTICATION IMPLEMENTATION ======
    document.addEventListener('DOMContentLoaded', function() {
      // Auth elements
      const authScreen = document.getElementById('auth-screen');
      const appContainer = document.getElementById('app-container');
      const loginForm = document.getElementById('login-form');
      const signupForm = document.getElementById('signup-form');
      const loginError = document.getElementById('login-error');
      const signupError = document.getElementById('signup-error');
      const authSwitchText = document.getElementById('auth-switch-text');
      const authSwitchLink = document.getElementById('auth-switch-link');
      const logoutButton = document.getElementById('btn-logout');
      const userNameElement = document.getElementById('user-name');
      const themeToggle = document.getElementById('theme-toggle');
      
      let isLoginMode = true;
      
      // Theme management
      const currentTheme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', currentTheme);
      themeToggle.innerHTML = currentTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      
      // Toggle theme
      themeToggle.addEventListener('click', () => {
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
        themeToggle.innerHTML = newTheme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
      });
      
      // Toggle between login and signup forms
      authSwitchLink.addEventListener('click', function() {
        isLoginMode = !isLoginMode;
        
        if (isLoginMode) {
          loginForm.style.display = 'flex';
          signupForm.style.display = 'none';
          authSwitchText.textContent = "Don't have an account?";
          authSwitchLink.textContent = "Sign up";
        } else {
          loginForm.style.display = 'none';
          signupForm.style.display = 'flex';
          authSwitchText.textContent = "Already have an account?";
          authSwitchLink.textContent = "Sign in";
        }
        
        // Clear errors
        loginError.textContent = '';
        signupError.textContent = '';
      });
      
      // Handle login form submission
      loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        
        // Show loading state
        const loginButton = loginForm.querySelector('button[type="submit"]');
        const restoreButton = utils.showLoading(loginButton);
        
        // Sign in with email and password
        auth.signInWithEmailAndPassword(email, password)
          .then((userCredential) => {
            // Signed in successfully
            loginError.textContent = '';
            showApplication(userCredential.user);
            utils.showToast('Signed in successfully');
          })
          .catch((error) => {
            // Handle errors
            const errorMsg = utils.handleError(error, 'Login');
            loginError.textContent = errorMsg;
          })
          .finally(() => {
            restoreButton();
          });
      });
      
      // Handle signup form submission
      signupForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const name = document.getElementById('signup-name').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;
        const confirmPassword = document.getElementById('signup-confirm').value;
        
        // Validate passwords match
        if (password !== confirmPassword) {
          signupError.textContent = "Passwords don't match";
          return;
        }
        
        // Show loading state
        const signupButton = signupForm.querySelector('button[type="submit"]');
        const restoreButton = utils.showLoading(signupButton);
        
        // Create user with email and password
        auth.createUserWithEmailAndPassword(email, password)
          .then((userCredential) => {
            // Update user profile with name
            return userCredential.user.updateProfile({
              displayName: name
            }).then(() => {
              signupError.textContent = '';
              showApplication(userCredential.user);
              utils.showToast('Account created successfully');
            });
          })
          .catch((error) => {
            // Handle errors
            const errorMsg = utils.handleError(error, 'Signup');
            signupError.textContent = errorMsg;
          })
          .finally(() => {
            restoreButton();
          });
      });
      
      // Handle logout
      logoutButton.addEventListener('click', function() {
        auth.signOut().then(() => {
          // Sign-out successful
          showAuthScreen();
          utils.showToast('Signed out successfully');
        }).catch((error) => {
          utils.handleError(error, 'Logout');
        });
      });
      
      // Check if user is already logged in
      auth.onAuthStateChanged((user) => {
        if (user) {
          // User is signed in
          showApplication(user);
        } else {
          // User is signed out
          showAuthScreen();
        }
      });
      
      // Helper function to show auth screen
      function showAuthScreen() {
        authScreen.style.display = 'flex';
        appContainer.style.display = 'none';
        
        // Reset forms
        loginForm.reset();
        signupForm.reset();
        loginError.textContent = '';
        signupError.textContent = '';
      }
      
      // Helper function to show application
      function showApplication(user) {
        authScreen.style.display = 'none';
        appContainer.style.display = 'block';
        
        // Display user name
        userNameElement.textContent = user.displayName || user.email;
        
        // Initialize the application
        initializeApp(user);
      }
    });
    
    // ====== APPLICATION INITIALIZATION ======
    function initializeApp(user) {
      // Constants
      const CURRENCY_SYMBOLS = {
        USD: '$', ZWL: 'Z$', ZAR: 'R', EUR: '‚Ç¨'
      };
      
      // State
      let loans = [];
      let editId = null;
      let payId = null;
      let currentReceiptLoanId = null;
      let userId = user.uid;
      let isOnline = false;
      let firebaseInitialized = false;
      let nextReferenceId = 9; // Starting at 009
      
      // DOM Elements cache
      const elements = {};
      
      // Initialize DOM elements cache
      function cacheElements() {
        const ids = [
          'loanForm', 'clientName', 'phone', 'principal', 'interestPct', 'interestType',
          'issueDate', 'dueDate', 'currency', 'reference', 'notes', 'totalPreview',
          'search', 'statusFilter', 'sortBy', 'tableWrap', 'paymentDialog', 'paymentForm',
          'paymentLoanTitle', 'payAmount', 'payDate', 'payNote', 'editDialog', 'editForm',
          'editClientName', 'editPhone', 'editPrincipal', 'editInterestPct', 'editInterestType',
          'editIssueDate', 'editDueDate', 'editCurrency', 'editReference', 'editNotes', 
          'receiptDialog', 'receiptContent', 'btn-close-receipt', 'btn-copy-receipt', 
          'btn-print-receipt', 'btn-export-pdf', 'btn-share-whatsapp', 'btn-export-json', 
          'btn-export-csv', 'btn-clear', 'btn-receipt-preview', 'now', 'connection-status',
          'btn-submit-loan', 'btn-submit-payment', 'btn-submit-edit', 'dashboard-summary',
          'total-loans', 'active-loans', 'total-due', 'overdue-loans', 'loans-trend',
          'active-trend', 'due-trend', 'overdue-trend', 'btn-reminders', 'reminderDialog',
          'reminder-list', 'btn-close-reminders', 'btn-send-reminders', 'reminder-count',
          'whatsappDialog', 'whatsappForm', 'whatsappLoanTitle', 'whatsappNumber', 'whatsappMessage', 'btn-send-whatsapp',
          'reminder-summary'
        ];
        
        ids.forEach(id => {
          elements[id] = document.getElementById(id);
        });
      }
      
      // Generate auto-incrementing reference ID
      function generateReferenceId() {
        const refId = `REF-${nextReferenceId.toString().padStart(3, '0')}`;
        nextReferenceId++;
        return refId;
      }
      
      // Financial calculations
      const calculator = {
        computeTotals: (loan) => {
          const principal = utils.safeParseFloat(loan.principal);
          const rate = utils.safeParseFloat(loan.interestPct) / 100;
          const start = new Date(loan.issueDate);
          const end = new Date(loan.dueDate);
          
          // Validate dates
          if (isNaN(start.getTime()) || isNaN(end.getTime())) {
            return { totalDue: principal, paid: 0, balance: principal };
          }
          
          const days = Math.max(1, Math.ceil((end - start) / (1000 * 60 * 60 * 24)));
          
          let totalDue = principal;
          
          switch (loan.interestType) {
            case 'compound_monthly':
              const months = Math.max(1, Math.ceil(days / 30));
              totalDue = principal * Math.pow(1 + rate / 12, months);
              break;
            case 'compound_daily':
              totalDue = principal * Math.pow(1 + rate / 365, days);
              break;
            case 'flat':
            default:
              totalDue = principal + principal * rate;
              break;
          }
          
          totalDue = +totalDue.toFixed(2);
          const paid = (loan.payments || []).reduce((sum, payment) => sum + utils.safeParseFloat(payment.amount), 0);
          const balance = +(totalDue - paid).toFixed(2);
          
          return { totalDue, paid, balance };
        },
        
        getStatus: (loan) => {
          const { balance } = calculator.computeTotals(loan);
          if (balance <= 0) return 'collected';
          
          // Validate due date
          const dueDate = new Date(loan.dueDate);
          if (isNaN(dueDate.getTime())) return 'active';
          
          if (dueDate < new Date()) return 'overdue';
          return 'active';
        },
        
        getStatusClass: (status) => {
          switch (status) {
            case 'active': return 'badge ok';
            case 'overdue': return 'badge danger';
            case 'collected': return 'badge neutral';
            default: return 'badge neutral';
          }
        },
        
        getStatusIndicator: (status) => {
          switch (status) {
            case 'active': return 'status-active';
            case 'overdue': return 'status-overdue';
            case 'collected': return 'status-collected';
            default: return '';
          }
        }
      };
      
      // Dashboard functions
      const dashboard = {
        updateSummary: () => {
          if (loans.length === 0) {
            elements['total-loans'].textContent = '0';
            elements['active-loans'].textContent = '0';
            elements['total-due'].textContent = '$0.00';
            elements['overdue-loans'].textContent = '0';
            return;
          }
          
          // Calculate totals
          const totalLoans = loans.length;
          const activeLoans = loans.filter(loan => calculator.getStatus(loan) === 'active').length;
          const overdueLoans = loans.filter(loan => calculator.getStatus(loan) === 'overdue').length;
          
          // Calculate total due amount
          let totalDueAmount = 0;
          loans.forEach(loan => {
            const { balance } = calculator.computeTotals(loan);
            if (balance > 0) {
              totalDueAmount += balance;
            }
          });
          
          // Update UI
          elements['total-loans'].textContent = totalLoans;
          elements['active-loans'].textContent = activeLoans;
          elements['overdue-loans'].textContent = overdueLoans;
          elements['total-due'].textContent = utils.formatCurrency(totalDueAmount);
          
          // For demo purposes, set random trends
          const trends = ['up', 'down'];
          const randomTrend = trends[Math.floor(Math.random() * trends.length)];
          const randomPercent = (Math.random() * 15 + 5).toFixed(1);
          
          // Update trend indicators
          const trendElements = [
            elements['loans-trend'],
            elements['active-trend'],
            elements['due-trend'],
            elements['overdue-trend']
          ];
          
          trendElements.forEach(el => {
            el.className = `trend ${randomTrend}`;
            el.innerHTML = `<i class="fas fa-arrow-${randomTrend}"></i><span>${randomPercent}% from last month</span>`;
          });
        },
        
        // Get reminders for overdue and upcoming loans
        getReminders: () => {
          const reminders = [];
          const today = new Date();
          
          loans.forEach(loan => {
            const status = calculator.getStatus(loan);
            const dueDate = new Date(loan.dueDate);
            
            if (status === 'overdue') {
              const daysOverdue = utils.daysBetween(today, dueDate);
              reminders.push({
                type: 'overdue',
                loan: loan,
                days: daysOverdue,
                message: `${loan.clientName} is ${daysOverdue} days overdue on ${utils.formatCurrency(calculator.computeTotals(loan).balance, loan.currency)} payment`
              });
            } else if (status === 'active') {
              const daysUntilDue = utils.daysBetween(today, dueDate);
              
              // Add reminder for loans due in 3 days or less
              if (daysUntilDue <= 3) {
                reminders.push({
                  type: 'upcoming',
                  loan: loan,
                  days: daysUntilDue,
                  message: `${loan.clientName} has payment due in ${daysUntilDue} day${daysUntilDue !== 1 ? 's' : ''}`
                });
              }
            }
          });
          
          // Sort reminders: overdue first, then by days until due
          reminders.sort((a, b) => {
            if (a.type === 'overdue' && b.type !== 'overdue') return -1;
            if (a.type !== 'overdue' && b.type === 'overdue') return 1;
            return a.days - b.days;
          });
          
          return reminders;
        },
        
        // Update reminder count badge
        updateReminderCount: () => {
          const reminders = dashboard.getReminders();
          elements['reminder-count'].textContent = reminders.length;
        },
        
        // Show reminders dialog
        showReminders: () => {
          const reminders = dashboard.getReminders();
          const reminderList = elements['reminder-list'];
          
          if (reminders.length === 0) {
            reminderList.innerHTML = '<div class="empty">No reminders at this time</div>';
            elements['reminder-summary'].textContent = '0 upcoming reminders';
            return;
          }
          
          let html = '';
          reminders.forEach(reminder => {
            const { loan, message, type, days } = reminder;
            const icon = type === 'overdue' ? '‚è∞' : 'üîî';
            const statusClass = type === 'overdue' ? 'badge danger' : 'badge warn';
            
            html += `
              <div class="reminder-item">
                <div>
                  <div class="reminder-client">${icon} ${loan.clientName}</div>
                  <div class="reminder-details">${message}</div>
                </div>
                <div class="${statusClass}">${type === 'overdue' ? 'OVERDUE' : 'DUE SOON'}</div>
              </div>
            `;
          });
          
          reminderList.innerHTML = html;
          elements['reminder-summary'].textContent = `${reminders.length} reminder${reminders.length !== 1 ? 's' : ''}`;
          elements['reminderDialog'].showModal();
        },
        
        // Send WhatsApp reminder
        sendWhatsAppReminder: (loan) => {
          if (!loan.phone) {
            utils.showToast('No phone number available for this client', 'error');
            return;
          }
          
          const { balance } = calculator.computeTotals(loan);
          const dueDate = new Date(loan.dueDate);
          const today = new Date();
          const isOverdue = dueDate < today;
          const daysDiff = utils.daysBetween(today, dueDate);
          
          let message = `Hello ${loan.clientName}, this is a reminder from Koo Cash Loans. `;
          
          if (isOverdue) {
            message += `Your payment of ${utils.formatCurrency(balance, loan.currency)} is ${daysDiff} days overdue. Please make payment as soon as possible.`;
          } else {
            message += `Your payment of ${utils.formatCurrency(balance, loan.currency)} is due in ${daysDiff} days on ${utils.formatDate(loan.dueDate)}.`;
          }
          
          message += ` Thank you.`;
          
          // Prefill WhatsApp dialog
          elements['whatsappLoanTitle'].textContent = `Send WhatsApp to ${loan.clientName}`;
          elements['whatsappNumber'].value = loan.phone;
          elements['whatsappMessage'].value = message;
          
          elements['whatsappDialog'].showModal();
        }
      };
      
      // Firebase operations
      const firebaseService = {
        init: async () => {
          try {
            utils.updateConnectionStatus(elements['connection-status'], 'connecting');
            
            // Set up real-time listener
            firebaseService.setupListener();
            
            // Update connection status
            firebaseService.updateConnectionStatus(true);
            firebaseInitialized = true;
            return true;
          } catch (error) {
            utils.handleError(error, 'Firebase initialization');
            firebaseService.updateConnectionStatus(false);
            firebaseInitialized = false;
            return false;
          }
        },
        
        setupListener: () => {
          try {
            const q = firebase.firestore()
              .collection('loans')
              .where('userId', '==', userId);
            
            q.onSnapshot((snapshot) => {
              loans = [];
              snapshot.forEach((doc) => {
                loans.push({ id: doc.id, ...doc.data() });
              });
              
              // Update next reference ID based on existing loans
              loans.forEach(loan => {
                if (loan.reference && loan.reference.startsWith('REF-')) {
                  const refNum = parseInt(loan.reference.replace('REF-', ''));
                  if (!isNaN(refNum) && refNum >= nextReferenceId) {
                    nextReferenceId = refNum + 1;
                  }
                }
              });
              
              // Update dashboard and table
              dashboard.updateSummary();
              dashboard.updateReminderCount();
              renderer.renderLoansTable();
              
              utils.updateConnectionStatus(elements['connection-status'], 'online');
            }, (error) => {
              utils.handleError(error, 'Firebase listener');
              utils.updateConnectionStatus(elements['connection-status'], 'offline');
            });
          } catch (error) {
            utils.handleError(error, 'Firebase listener setup');
            utils.updateConnectionStatus(elements['connection-status'], 'offline');
          }
        },
        
        updateConnectionStatus: (connected) => {
          isOnline = connected;
          if (connected) {
            utils.updateConnectionStatus(elements['connection-status'], 'online');
          } else {
            utils.updateConnectionStatus(elements['connection-status'], 'offline');
          }
        },
        
        addLoan: async (loan) => {
          try {
            const loanWithUserId = { ...loan, userId };
            const docRef = await firebase.firestore().collection('loans').add(loanWithUserId);
            return docRef.id;
          } catch (error) {
            throw error;
          }
        },
        
        updateLoan: async (loanId, updates) => {
          try {
            await firebase.firestore().collection('loans').doc(loanId).update(updates);
            return true;
          } catch (error) {
            throw error;
          }
        },
        
        deleteLoan: async (loanId) => {
          try {
            await firebase.firestore().collection('loans').doc(loanId).delete();
            return true;
          } catch (error) {
            throw error;
          }
        },
        
        exportToJson: () => {
          try {
            const dataStr = JSON.stringify(loans, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `koo-cash-loans-backup-${utils.todayISO()}.json`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }, 100);
            
            utils.showToast('Data exported successfully');
          } catch (error) {
            utils.handleError(error, 'JSON export');
          }
        },
        
        exportToCsv: () => {
          try {
            const headers = ['Client', 'Phone', 'Reference', 'Principal', 'Interest%', 'InterestType', 
                            'IssueDate', 'DueDate', 'Currency', 'TotalDue', 'Paid', 'Balance', 
                            'Status', 'Notes', 'Payments'];
            
            const rows = loans.map(loan => {
              const totals = calculator.computeTotals(loan);
              const status = calculator.getStatus(loan);
              const payments = (loan.payments || [])
                .map(p => `${p.date}: ${utils.formatCurrency(p.amount, loan.currency)}${p.note ? ` (${p.note})` : ''}`)
                .join('; ');
                
              return [
                loan.clientName,
                loan.phone || '',
                loan.reference || '',
                loan.principal,
                loan.interestPct,
                loan.interestType || 'flat',
                loan.issueDate,
                loan.dueDate,
                loan.currency,
                totals.totalDue,
                totals.paid,
                totals.balance,
                status,
                (loan.notes || '').replace(/\n/g, ' '),
                payments
              ].map(field => `"${String(field).replace(/"/g, '""')}"`);
            });
            
            const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `koo-cash-loans-${utils.todayISO()}.csv`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
              document.body.removeChild(a);
              URL.revokeObjectURL(url);
            }, 100);
            
            utils.showToast('Data exported successfully');
          } catch (error) {
            utils.handleError(error, 'CSV export');
          }
        },
        
        clearAll: async () => {
          if (confirm('Are you sure you want to clear ALL data? This cannot be undone.')) {
            try {
              // Delete all loans from Firebase
              const deletePromises = loans.map(loan => firebaseService.deleteLoan(loan.id));
              await Promise.all(deletePromises);
              utils.showToast('All data cleared successfully');
            } catch (error) {
              utils.handleError(error, 'Clear all data');
            }
          }
        }
      };
      
      // UI rendering
      const renderer = {
        updateLoanPreview: () => {
          const principal = utils.safeParseFloat(elements.principal.value);
          const interestPct = utils.safeParseFloat(elements.interestPct.value);
          const interestType = elements.interestType.value;
          const issueDate = elements.issueDate.value || utils.todayISO();
          const dueDate = elements.dueDate.value || utils.todayISO();
          const currency = elements.currency.value;
          
          const tempLoan = {
            principal,
            interestPct,
            interestType,
            issueDate,
            dueDate
          };
          
          const { totalDue } = calculator.computeTotals(tempLoan);
          elements.totalPreview.textContent = utils.formatCurrency(totalDue, currency);
        },
        
        renderLoansTable: () => {
          const searchTerm = (elements.search.value || '').toLowerCase();
          const statusFilter = elements.statusFilter.value;
          const sortBy = elements.sortBy.value;
          
          // Filter loans
          let filteredLoans = loans.map(loan => ({
            ...loan,
            ...calculator.computeTotals(loan),
            status: calculator.getStatus(loan)
          }));
          
          if (searchTerm) {
            filteredLoans = filteredLoans.filter(loan => 
              (loan.clientName || '').toLowerCase().includes(searchTerm) ||
              (loan.phone || '').toLowerCase().includes(searchTerm) ||
              (loan.reference || '').toLowerCase().includes(searchTerm)
            );
          }
          
          if (statusFilter !== 'all') {
            filteredLoans = filteredLoans.filter(loan => loan.status === statusFilter);
          }
          
          // Sort loans
          filteredLoans.sort((a, b) => {
            switch (sortBy) {
              case 'clientName': return (a.clientName || '').localeCompare(b.clientName || '');
              case 'createdAt': return new Date(a.createdAt) - new Date(b.createdAt);
              case 'balance': return a.balance - b.balance;
              case 'dueDate':
              default: 
                const dateA = new Date(a.dueDate);
                const dateB = new Date(b.dueDate);
                // Handle invalid dates by putting them at the end
                if (isNaN(dateA.getTime())) return 1;
                if (isNaN(dateB.getTime())) return -1;
                return dateA - dateB;
            }
          });
          
          // Render table or empty state
          if (filteredLoans.length === 0) {
            elements.tableWrap.innerHTML = `
              <div class="empty">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="opacity:0.5;margin-bottom:16px;">
                  <path d="M19 5H5C3.89543 5 3 5.89543 3 7V17C3 18.1046 3.89543 19 5 19H19C20.1046 19 21 18.1046 21 17V7C21 5.89543 20.1046 5 19 5Z" stroke="currentColor" stroke-width="2"/>
                  <path d="M3 7L12 13L21 7" stroke="currentColor" stroke-width="2"/>
                </svg>
                <p>No loans found. ${!firebaseInitialized ? 'Connection issues detected.' : ''}</p>
              </div>
            `;
            return;
          }
          
          const rows = filteredLoans.map(loan => {
            const statusClass = calculator.getStatusClass(loan.status);
            const statusIndicator = calculator.getStatusIndicator(loan.status);
            const paymentsHTML = (loan.payments || [])
              .map(p => `<div>${utils.formatDate(p.date)}: ${utils.formatCurrency(p.amount, loan.currency)} ${p.note ? `<span class="muted">(${p.note})</span>` : ''}</div>`)
              .join('') || '<span class="muted">‚Äî</span>';
              
            return `
              <tr class="fade-in">
                <td>
                  <div style="font-weight:700;">${loan.clientName||''}</div>
                  <div class="muted" style="font-size:12px;">${loan.phone||''} ${loan.reference?` ‚Ä¢ ${loan.reference}`:''}</div>
                </td>
                <td class="mono">${utils.formatCurrency(loan.principal, loan.currency)}</td>
                <td>${loan.interestPct}%<div class="muted" style="font-size:12px;">${loan.interestType || 'flat'}</div></td>
                <td class="mono">${utils.formatCurrency(loan.totalDue, loan.currency)}</td>
                <td class="mono">${utils.formatCurrency(loan.paid, loan.currency)}</td>
                <td class="mono">${utils.formatCurrency(loan.balance, loan.currency)}</td>
                <td>
                  <div class="badge ${statusClass}">
                    <span class="status-indicator ${statusIndicator}"></span>
                    ${loan.status.toUpperCase()}
                  </div>
                </td>
                <td>${utils.formatDate(loan.issueDate)}</td>
                <td>${utils.formatDate(loan.dueDate)}</td>
                <td>
                  <div class="toolbar">
                    <button class="btn" data-action="payment" data-id="${loan.id}" title="Record payment">üí∞</button>
                    <button class="btn" data-action="edit" data-id="${loan.id}" title="Edit loan">‚úèÔ∏è</button>
                    <button class="btn" data-action="receipt" data-id="${loan.id}" title="View receipt">üßæ</button>
                    <button class="btn danger" data-action="delete" data-id="${loan.id}" title="Delete loan">üóëÔ∏è</button>
                  </div>
                  <div style="font-size:12px; margin-top:4px; color:var(--muted);">
                    ${paymentsHTML}
                  </div>
                </td>
              </tr>
            `;
          }).join('');
          
          elements.tableWrap.innerHTML = `
            <table>
              <thead>
                <tr>
                  <th>Client</th>
                  <th>Principal</th>
                  <th>Interest</th>
                  <th>Total Due</th>
                  <th>Paid</th>
                  <th>Balance</th>
                  <th>Status</th>
                  <th>Issued</th>
                  <th>Due</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${rows}
              </tbody>
            </table>
          `;
          
          // Add event listeners to action buttons
          elements.tableWrap.querySelectorAll('[data-action]').forEach(button => {
            button.addEventListener('click', () => {
              const action = button.dataset.action;
              const id = button.dataset.id;
              handlers.handleTableAction(action, id);
            });
          });
        },
        
        showPaymentDialog: (loan) => {
          if (!loan) return;
          
          elements.paymentLoanTitle.textContent = `Record payment for ${loan.clientName} (Balance: ${utils.formatCurrency(loan.balance, loan.currency)})`;
          elements.payAmount.value = '';
          elements.payAmount.setAttribute('max', loan.balance);
          elements.payDate.value = utils.todayISO();
          elements.payNote.value = '';
          
          elements.paymentDialog.showModal();
          elements.payAmount.focus();
        },
        
        showEditDialog: (loan) => {
          if (!loan) return;
          
          elements.editClientName.value = loan.clientName || '';
          elements.editPhone.value = loan.phone || '';
          elements.editPrincipal.value = loan.principal || '';
          elements.editInterestPct.value = loan.interestPct || '';
          elements.editInterestType.value = loan.interestType || 'flat';
          elements.editIssueDate.value = loan.issueDate || '';
          elements.editDueDate.value = loan.dueDate || '';
          elements.editCurrency.value = loan.currency || 'USD';
          elements.editReference.value = loan.reference || '';
          elements.editNotes.value = loan.notes || '';
          
          elements.editDialog.showModal();
        },
        
        showReceipt: (loan) => {
          if (!loan) return;
          
          const { totalDue, paid, balance } = calculator.computeTotals(loan);
          const status = calculator.getStatus(loan);
          
          const receiptHTML = `
            <div style="max-width:400px; margin:0 auto; padding:20px; border:1px solid var(--border); border-radius:var(--radius);">
              <div style="text-align:center; margin-bottom:20px;">
                <h2 style="margin:0; color:var(--brand);">Koo Cash Loan</h2>
                <p class="muted">Loan Receipt</p>
              </div>
              
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px;">
                <div>
                  <strong>Client:</strong><br>
                  ${loan.clientName}<br>
                  ${loan.phone ? loan.phone + '<br>' : ''}
                  ${loan.reference ? 'Ref: ' + loan.reference : ''}
                </div>
                <div style="text-align:right;">
                  <strong>Date:</strong> ${utils.formatDate(loan.issueDate)}<br>
                  <strong>Due:</strong> ${utils.formatDate(loan.dueDate)}<br>
                  <strong>Status:</strong> ${status.toUpperCase()}
                </div>
              </div>
              
              <div style="border-top:1px solid var(--border); padding-top:15px; margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                  <span>Principal Amount:</span>
                  <span>${utils.formatCurrency(loan.principal, loan.currency)}</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                  <span>Interest (${loan.interestPct}% ${loan.interestType}):</span>
                  <span>${utils.formatCurrency(totalDue - loan.principal, loan.currency)}</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-weight:bold; margin-bottom:8px; border-top:1px solid var(--border); padding-top:8px;">
                  <span>Total Due:</span>
                  <span>${utils.formatCurrency(totalDue, loan.currency)}</span>
                </div>
                <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:var(--ok);">
                  <span>Amount Paid:</span>
                  <span>${utils.formatCurrency(paid, loan.currency)}</span>
                </div>
                <div style="display:flex; justify-content:space-between; font-weight:bold; border-top:1px solid var(--border); padding-top:8px;">
                  <span>Balance:</span>
                  <span>${utils.formatCurrency(balance, loan.currency)}</span>
                </div>
              </div>
              
              ${loan.notes ? `
                <div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);">
                  <strong>Notes:</strong><br>
                  ${loan.notes}
                </div>
              ` : ''}
              
              ${loan.payments && loan.payments.length > 0 ? `
                <div style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);">
                  <strong>Payment History:</strong>
                  ${loan.payments.map(p => `
                    <div style="display:flex; justify-content:space-between; margin-top:5px; font-size:14px;">
                      <span>${utils.formatDate(p.date)} ${p.note ? '(' + p.note + ')' : ''}:</span>
                      <span>${utils.formatCurrency(p.amount, loan.currency)}</span>
                    </div>
                  `).join('')}
                </div>
              ` : ''}
              
              <div style="margin-top:20px; text-align:center; color:var(--muted); font-size:12px;">
                Generated on ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
              </div>
            </div>
          `;
          
          elements.receiptContent.innerHTML = receiptHTML;
          
          // Also create a printable version
          document.getElementById('receipt-printable').innerHTML = receiptHTML;
          
          elements.receiptDialog.showModal();
        }
      };
      
      // Event handlers
      const handlers = {
        handleTableAction: (action, id) => {
          const loan = loans.find(l => l.id === id);
          if (!loan) return;
          
          switch (action) {
            case 'payment':
              renderer.showPaymentDialog(loan);
              payId = id;
              break;
            case 'edit':
              renderer.showEditDialog(loan);
              editId = id;
              break;
            case 'receipt':
              renderer.showReceipt(loan);
              currentReceiptLoanId = id;
              break;
            case 'delete':
              if (confirm(`Are you sure you want to delete the loan for ${loan.clientName}?`)) {
                firebaseService.deleteLoan(id)
                  .then(() => {
                    utils.showToast('Loan deleted successfully');
                  })
                  .catch(error => {
                    utils.handleError(error, 'Delete loan');
                  });
              }
              break;
          }
        },
        
        handleLoanSubmit: (e) => {
          e.preventDefault();
          
          const formData = {
            clientName: elements.clientName.value.trim(),
            phone: elements.phone.value.trim(),
            principal: utils.safeParseFloat(elements.principal.value),
            interestPct: utils.safeParseFloat(elements.interestPct.value),
            interestType: elements.interestType.value,
            issueDate: elements.issueDate.value,
            dueDate: elements.dueDate.value,
            currency: elements.currency.value,
            reference: elements.reference.value.trim() || generateReferenceId(),
            notes: elements.notes.value.trim(),
            createdAt: new Date().toISOString(),
            payments: []
          };
          
          // Validate form
          const errors = utils.validateForm(formData);
          if (errors.length > 0) {
            utils.showToast('Please fix form errors: ' + errors.join(', '), 'error');
            return;
          }
          
          // Add loan to Firebase
          const restoreButton = utils.showLoading(elements['btn-submit-loan']);
          firebaseService.addLoan(formData)
            .then(() => {
              // Reset form and update UI
              elements.loanForm.reset();
              elements.issueDate.value = utils.todayISO();
              elements.dueDate.value = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
              renderer.updateLoanPreview();
              
              // Show receipt for the new loan
              renderer.showReceipt(formData);
              utils.showToast('Loan added successfully');
            })
            .catch(error => {
              utils.handleError(error, 'Add loan');
            })
            .finally(() => {
              restoreButton();
            });
        },
        
        handlePaymentSubmit: (e) => {
          e.preventDefault();
          
          const payment = {
            amount: utils.safeParseFloat(elements.payAmount.value),
            date: elements.payDate.value,
            note: elements.payNote.value.trim()
          };
          
          if (!payment.amount || payment.amount <= 0) {
            utils.showToast('Please enter a valid payment amount', 'error');
            return;
          }
          
          // Find the loan and update it
          const loanIndex = loans.findIndex(l => l.id === payId);
          if (loanIndex === -1) {
            utils.showToast('Loan not found', 'error');
            return;
          }
          
          if (!loans[loanIndex].payments) {
            loans[loanIndex].payments = [];
          }
          
          loans[loanIndex].payments.push(payment);
          
          const restoreButton = utils.showLoading(elements['btn-submit-payment']);
          firebaseService.updateLoan(payId, { payments: loans[loanIndex].payments })
            .then(() => {
              // Close dialog and update UI
              elements.paymentDialog.close();
              utils.showToast('Payment recorded successfully');
            })
            .catch(error => {
              utils.handleError(error, 'Save payment');
            })
            .finally(() => {
              restoreButton();
            });
        },
        
        handleEditSubmit: (e) => {
          e.preventDefault();
          
          const updates = {
            clientName: elements.editClientName.value.trim(),
            phone: elements.editPhone.value.trim(),
            principal: utils.safeParseFloat(elements.editPrincipal.value),
            interestPct: utils.safeParseFloat(elements.editInterestPct.value),
            interestType: elements.editInterestType.value,
            issueDate: elements.editIssueDate.value,
            dueDate: elements.editDueDate.value,
            currency: elements.editCurrency.value,
            reference: elements.editReference.value.trim(),
            notes: elements.editNotes.value.trim()
          };
          
          // Validate form
          const errors = utils.validateForm(updates);
          if (errors.length > 0) {
            utils.showToast('Please fix form errors: ' + errors.join(', '), 'error');
            return;
          }
          
          const restoreButton = utils.showLoading(elements['btn-submit-edit']);
          firebaseService.updateLoan(editId, updates)
            .then(() => {
              // Close dialog and update UI
              elements.editDialog.close();
              utils.showToast('Loan updated successfully');
            })
            .catch(error => {
              utils.handleError(error, 'Update loan');
            })
            .finally(() => {
              restoreButton();
            });
        },
        
        handleReceiptActions: (action) => {
          const loan = loans.find(l => l.id === currentReceiptLoanId);
          if (!loan) return;
          
          const { totalDue, paid, balance } = calculator.computeTotals(loan);
          
          switch (action) {
            case 'copy':
              const text = `
                Koo Cash Loan Receipt
                Client: ${loan.clientName}
                Phone: ${loan.phone || 'N/A'}
                Reference: ${loan.reference || 'N/A'}
                Issue Date: ${utils.formatDate(loan.issueDate)}
                Due Date: ${utils.formatDate(loan.dueDate)}
                Principal: ${utils.formatCurrency(loan.principal, loan.currency)}
                Interest: ${loan.interestPct}% ${loan.interestType}
                Total Due: ${utils.formatCurrency(totalDue, loan.currency)}
                Amount Paid: ${utils.formatCurrency(paid, loan.currency)}
                Balance: ${utils.formatCurrency(balance, loan.currency)}
                Status: ${calculator.getStatus(loan).toUpperCase()}
                ${loan.notes ? `Notes: ${loan.notes}` : ''}
              `.replace(/^ +/gm, '');
              
              navigator.clipboard.writeText(text)
                .then(() => utils.showToast('Receipt copied to clipboard!'))
                .catch(err => utils.handleError(err, 'Copy receipt'));
              break;
              
            case 'print':
              window.print();
              break;
              
            case 'pdf':
              const printableElement = document.getElementById('receipt-printable');
              utils.exportToPdf(printableElement, `receipt-${loan.clientName}-${utils.todayISO()}.pdf`);
              utils.showToast('PDF downloaded successfully');
              break;
              
            case 'whatsapp':
              dashboard.sendWhatsAppReminder(loan);
              break;
              
            case 'close':
              elements.receiptDialog.close();
              break;
          }
        },
        
        handleWhatsAppSubmit: (e) => {
          e.preventDefault();
          
          const phoneNumber = elements.whatsappNumber.value;
          const message = elements.whatsappMessage.value;
          
          if (!phoneNumber) {
            utils.showToast('Phone number is required', 'error');
            return;
          }
          
          // Format phone number for WhatsApp (remove any non-digit characters)
          const formattedPhone = utils.formatPhoneNumber(phoneNumber);
          
          // Create WhatsApp link
          const whatsappLink = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
          
          // Open WhatsApp
          window.open(whatsappLink, '_blank');
          
          // Close dialog
          elements.whatsappDialog.close();
          utils.showToast('WhatsApp opened with message');
        },
        
        handleSendAllReminders: () => {
          const reminders = dashboard.getReminders();
          
          if (reminders.length === 0) {
            utils.showToast('No reminders to send', 'info');
            return;
          }
          
          // For each reminder with a phone number, prepare WhatsApp
          reminders.forEach(reminder => {
            if (reminder.loan.phone) {
              dashboard.sendWhatsAppReminder(reminder.loan);
            }
          });
          
          utils.showToast(`Prepared ${reminders.length} reminders for sending`);
          elements.reminderDialog.close();
        }
      };
      
      // Initialize the application
      function init() {
        cacheElements();
        
        // Set current date in the UI
        elements.now.textContent = new Date().toLocaleDateString();
        
        // Set default dates
        const today = utils.todayISO();
        const in30Days = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().slice(0, 10);
        elements.issueDate.value = today;
        elements.dueDate.value = in30Days;
        
        // Set default reference ID
        elements.reference.value = generateReferenceId();
        
        // Initialize Firebase
        firebaseService.init();
        
        // Set up event listeners
        elements.loanForm.addEventListener('submit', handlers.handleLoanSubmit);
        elements.paymentForm.addEventListener('submit', handlers.handlePaymentSubmit);
        elements.editForm.addEventListener('submit', handlers.handleEditSubmit);
        elements.whatsappForm.addEventListener('submit', handlers.handleWhatsAppSubmit);
        
        // Button listeners
        elements.btnReminders.addEventListener('click', dashboard.showReminders);
        elements.btnCloseReminders.addEventListener('click', () => elements.reminderDialog.close());
        elements.btnSendReminders.addEventListener('click', handlers.handleSendAllReminders);
        
        elements.btnCloseReceipt.addEventListener('click', () => handlers.handleReceiptActions('close'));
        elements.btnCopyReceipt.addEventListener('click', () => handlers.handleReceiptActions('copy'));
        elements.btnPrintReceipt.addEventListener('click', () => handlers.handleReceiptActions('print'));
        elements.btnExportPdf.addEventListener('click', () => handlers.handleReceiptActions('pdf'));
        elements.btnShareWhatsapp.addEventListener('click', () => handlers.handleReceiptActions('whatsapp'));
        
        elements.btnReceiptPreview.addEventListener('click', () => {
          const formData = {
            clientName: elements.clientName.value.trim() || 'Sample Client',
            phone: elements.phone.value.trim() || '0771234567',
            principal: utils.safeParseFloat(elements.principal.value) || 1000,
            interestPct: utils.safeParseFloat(elements.interestPct.value) || 20,
            interestType: elements.interestType.value,
            issueDate: elements.issueDate.value,
            dueDate: elements.dueDate.value,
            currency: elements.currency.value,
            reference: elements.reference.value.trim() || generateReferenceId(),
            notes: elements.notes.value.trim() || 'Sample loan for demonstration purposes',
            payments: []
          };
          
          renderer.showReceipt(formData);
        });
        
        elements.btnExportJson.addEventListener('click', firebaseService.exportToJson);
        elements.btnExportCsv.addEventListener('click', firebaseService.exportToCsv);
        elements.btnClear.addEventListener('click', firebaseService.clearAll);
        
        // Input event listeners
        elements.principal.addEventListener('input', utils.debounce(renderer.updateLoanPreview, 300));
        elements.interestPct.addEventListener('input', utils.debounce(renderer.updateLoanPreview, 300));
        elements.interestType.addEventListener('change', renderer.updateLoanPreview);
        elements.issueDate.addEventListener('change', renderer.updateLoanPreview);
        elements.dueDate.addEventListener('change', renderer.updateLoanPreview);
        
        // Filter and search listeners
        elements.search.addEventListener('input', utils.debounce(renderer.renderLoansTable, 300));
        elements.statusFilter.addEventListener('change', renderer.renderLoansTable);
        elements.sortBy.addEventListener('change', renderer.renderLoansTable);
        
        // Dialog close handlers
        elements.paymentDialog.addEventListener('close', () => {
          payId = null;
        });
        
        elements.editDialog.addEventListener('close', () => {
          editId = null;
        });
        
        // Initialize loan preview
        renderer.updateLoanPreview();
        
        // Set up keyboard shortcuts
        document.addEventListener('keydown', (e) => {
          if (e.ctrlKey && e.key === '/') {
            e.preventDefault();
            elements.search.focus();
          }
          
          // Escape key to close modals
          if (e.key === 'Escape') {
            if (elements.paymentDialog.open) elements.paymentDialog.close();
            if (elements.editDialog.open) elements.editDialog.close();
            if (elements.receiptDialog.open) elements.receiptDialog.close();
            if (elements.reminderDialog.open) elements.reminderDialog.close();
            if (elements.whatsappDialog.open) elements.whatsappDialog.close();
          }
        });
      }
      
      // Start the application
      init();
    }
  </script>
</body>
  </html>
